<script>
/* ============================================================
   Clash Royale Imposter — Full Logic Rewrite (UI preserved)
   ============================================================ */

/* -------------------- Data -------------------- */
const CLASH_CARDS = [
  'Arrows','Zap','Snowball','Rage','Clone','Mirror','Heal Spirit','Fireball','Poison','Rocket','Lightning','Earthquake','Tornado','The Log','Barbarian Barrel','Royal Delivery',
  'Skeletons','Ice Spirit','Fire Spirit','Bats','Spear Goblins','Goblins','Goblin Gang','Guards','Skeleton Army','Wall Breakers',
  'Archers','Knight','Bomber','Ice Golem','Minions','Minion Horde','Dart Goblin',
  'Musketeer','Wizard','Ice Wizard','Electro Wizard','Magic Archer',
  'Valkyrie','Mini P.E.K.K.A','Prince','Bandit','Battle Ram','Ram Rider','Lumberjack','Monk',
  'P.E.K.K.A','Giant','Goblin Giant','Royal Giant','Hog Rider','Mega Knight','Sparky','Balloon','X-Bow','Mortar',
  'Baby Dragon','Inferno Dragon','Electro Dragon','Phoenix',
  'Golem','Lava Hound','Graveyard','Miner','Goblin Barrel','Goblin Drill','Electro Giant',
  'Archer Queen','Skeleton King','Golden Knight','Mighty Miner','Little Prince'
];

/* -------------------- Helpers -------------------- */
const el = id => document.getElementById(id);
const screens = {
  setup: el("screen-setup"),
  pass: el("screen-pass"),
  summary: el("screen-summary")
};

function show(screen){
  Object.values(screens).forEach(s => s.classList.add("hidden"));
  screens[screen].classList.remove("hidden");
}

/* -------------------- Card Metadata -------------------- */
function cardMeta(card){
  const air = ['Minions','Minion Horde','Baby Dragon','Inferno Dragon','Electro Dragon','Balloon','Phoenix','Lava Hound'];
  const spells = ['Fireball','Poison','Rocket','Zap','Arrows','Snowball','Lightning','Tornado','The Log'];
  const tanks = ['Giant','Golem','Electro Giant','Mega Knight','P.E.K.K.A','Goblin Giant','Royal Giant','Lava Hound'];
  const wincons = ['Hog Rider','Balloon','Graveyard','X-Bow','Mortar','Goblin Drill','Miner','Battle Ram'];

  return {
    type: spells.includes(card) ? 'spell' : 'troop',
    movement: air.includes(card) ? 'air' : 'ground',
    role: wincons.includes(card) ? 'win condition' :
          tanks.includes(card) ? 'tank' : 'damage dealer',
    damage: ['Wizard','Baby Dragon','Fireball','Poison','Rocket','Bowler','Executioner']
              .includes(card) ? 'splash' : 'single',
    family: card.includes('Goblin') ? 'goblin' :
            card.includes('Skeleton') ? 'skeleton' :
            card.includes('Ice') ? 'ice' :
            card.includes('Electro') ? 'electro' : 'neutral'
  };
}

/* -------------------- State -------------------- */
let mode = 'clash'; // clash | dark

let state = {
  players: 6,
  impostors: 1,
  secretCard: null,
  roles: [],
  impostorCards: [],
  hint: null,
  turn: 0,
  revealed: false,
  history: []
};

/* -------------------- Setup -------------------- */
function readSetup(){
  state.players = Math.max(3, Math.min(20, Number(el('players').value)));
  state.impostors = Math.min(Number(el('impostors').value), state.players - 1);
}

function pickSecretCard(){
  state.secretCard = CLASH_CARDS[Math.floor(Math.random() * CLASH_CARDS.length)];
}

/* -------------------- Role Assignment -------------------- */
function assignRoles(){
  const indices = [...Array(state.players).keys()];
  indices.sort(() => Math.random() - 0.5);

  state.roles = Array(state.players).fill('PLAYER');
  indices.slice(0, state.impostors).forEach(i => state.roles[i] = 'IMPOSTOR');

  state.impostorCards = Array(state.players).fill(null);

  if(mode === 'dark'){
    for(let i = 0; i < state.players; i++){
      if(state.roles[i] === 'IMPOSTOR'){
        state.impostorCards[i] = pickDeceptiveCard(state.secretCard);
      }
    }
  }

  state.hint = mode === 'clash' ? generateHint(state.secretCard) : null;
  state.turn = 0;
  state.revealed = false;
  state.history = [];
}

/* -------------------- Normal Mode Hint -------------------- */
function generateHint(card){
  const m = cardMeta(card);
  const hints = [
    `Type: ${m.type}`,
    `Movement: ${m.movement}`,
    `Role: ${m.role}`,
    `Damage: ${m.damage}`
  ];

  // deterministic per round
  return hints[card.length % hints.length];
}

/* -------------------- In the Dark Algorithm -------------------- */
function pickDeceptiveCard(real){
  const base = cardMeta(real);

  let scored = CLASH_CARDS
    .filter(c => c !== real)
    .map(c => {
      const m = cardMeta(c);
      let score = 0;
      if(m.type === base.type) score += 5;
      if(m.movement === base.movement) score += 4;
      if(m.role === base.role) score += 3;
      if(m.damage === base.damage) score += 2;
      if(m.family === base.family) score += 1;
      return { c, score };
    });

  scored.sort((a,b) => b.score - a.score);
  const top = scored[0].score;
  const best = scored.filter(s => s.score === top);

  return best[Math.floor(Math.random() * best.length)].c;
}

/* -------------------- UI Flow -------------------- */
function updatePassUI(){
  el('turnInfo').textContent = `Player ${state.turn + 1} / ${state.players}`;

  if(!state.revealed){
    el('wordText').textContent = 'Tap to reveal';
    el('hint').textContent = 'Hand the phone to this player.';
    el('toggleBtn').textContent = 'Reveal';
    return;
  }

  const isImp = state.roles[state.turn] === 'IMPOSTOR';

  if(isImp){
    if(mode === 'dark'){
      el('wordText').textContent = state.impostorCards[state.turn];
      el('hint').textContent = 'You see a different card.';
    } else {
      el('wordText').textContent = 'IMPOSTOR';
      el('hint').textContent = 'You do not receive the hint.';
    }
  } else {
    el('wordText').textContent = state.secretCard;
    el('hint').textContent = state.hint ? `Hint → ${state.hint}` : '';
  }

  el('toggleBtn').textContent =
    state.turn === state.players - 1 ? 'Finish Round' : 'Next Player';
}

function nextTurn(){
  state.history.push({ player: state.turn + 1, role: state.roles[state.turn] });
  state.turn++;
  state.revealed = false;

  if(state.turn >= state.players){
    show('summary');
    return;
  }
  updatePassUI();
}

/* -------------------- Events -------------------- */
el('begin').onclick = () => {
  readSetup();
  pickSecretCard();
  assignRoles();
  show('pass');
  updatePassUI();
};

el('toggleBtn').onclick = () => {
  if(!state.revealed){
    state.revealed = true;
    updatePassUI();
  } else {
    nextTurn();
  }
};

el('showImpostors').onclick = () => {
  const list = state.history
    .filter(h => h.role === 'IMPOSTOR')
    .map(h => `Player ${h.player}`)
    .join(', ');
  el('impostorList').textContent = list || 'No impostors.';
  el('impostorList').classList.remove('hidden');
};

el('playAgain').onclick = () => show('setup');

/* -------------------- Mode Switching -------------------- */
function setMode(m){
  mode = m;
  el('modeClash').classList.toggle('primary', mode === 'clash');
  el('modeDark').classList.toggle('primary', mode === 'dark');
  el('darkControls').style.display = mode === 'dark' ? 'grid' : 'none';
}

el('modeClash').onclick = () => setMode('clash');
el('modeDark').onclick = () => setMode('dark');
</script>
